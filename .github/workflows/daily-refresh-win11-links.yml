name: Refresh Win11 ISO links (24h15m drift)

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  refresh:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # -----------------------------
    # Gate execution (24h15m)
    # -----------------------------
    - name: Gate by epoch
      id: gate
      shell: pwsh
      run: |
        $epochFile = ".github/next_run_epoch"
        $interval  = 87300

        $now = [int][DateTimeOffset]::UtcNow.ToUnixTimeSeconds()
        $next = 0

        if (Test-Path $epochFile) {
          $raw = (Get-Content $epochFile -Raw).Trim()
          if ($raw -match '^\d+$') { $next = [int]$raw }
        }

        if ($now -ge $next) {
          $newNext = if ($next -eq 0) { $now + $interval } else {
            while ($next -le $now) { $next += $interval }
            $next
          }

          "should_run=true"  >> $env:GITHUB_OUTPUT
          "next_epoch=$newNext" >> $env:GITHUB_OUTPUT
        } else {
          "should_run=false" >> $env:GITHUB_OUTPUT
          "next_epoch=$next" >> $env:GITHUB_OUTPUT
        }

    # -----------------------------
    # Download generator
    # -----------------------------
    - name: Download generator
      if: steps.gate.outputs.should_run == 'true'
      shell: pwsh
      run: |
        curl -fsSL -o gen.ps1 https://github.com/bprasad884uu/Gainwell/raw/refs/heads/main/Win11OSLinkGenerate.ps1

    # -----------------------------
    # Run generator (structured parse)
    # -----------------------------
    - name: Run generator
      if: steps.gate.outputs.should_run == 'true'
      id: gen
      shell: pwsh
      run: |
        $data = @{}
        pwsh -NoProfile -File ./gen.ps1 | ForEach-Object {
          if ($_ -match '^([^=]+)=(.+)$') {
            $data[$matches[1]] = $matches[2]
          }
        }

        $found = $data["FOUND"] -eq "true"
        "found=$found" >> $env:GITHUB_OUTPUT

        if ($data["ENGB"]) {
          "engb<<EOF" >> $env:GITHUB_OUTPUT
          $data["ENGB"] >> $env:GITHUB_OUTPUT
          "EOF" >> $env:GITHUB_OUTPUT
        }

        if ($data["ENUS"]) {
          "enus<<EOF" >> $env:GITHUB_OUTPUT
          $data["ENUS"] >> $env:GITHUB_OUTPUT
          "EOF" >> $env:GITHUB_OUTPUT
        }

    # -----------------------------
    # Replace URLs safely
    # -----------------------------
    - name: Update Windows11Upgrade.ps1
      if: steps.gen.outputs.found == 'true'
      id: replace
      shell: pwsh
      env:
        ENGB: ${{ steps.gen.outputs.engb }}
        ENUS: ${{ steps.gen.outputs.enus }}
      run: |
        $file = "Windows11Upgrade.ps1"
        if (-not (Test-Path $file)) {
          "updated=false" >> $env:GITHUB_OUTPUT
          exit 0
        }

        $text = Get-Content $file -Raw
        $updated = $false

        $patterns = @{
          ENGB = '(?ms)(\$isoUrl_EN_GB\s*=\s*)(["'']).*?\2'
          ENUS = '(?ms)(\$isoUrl_EN_US\s*=\s*)(["'']).*?\2'
        }

        foreach ($k in $patterns.Keys) {
          $val = $env:$k
          if ($val) {
            $new = [regex]::Replace(
              $text,
              $patterns[$k],
              '${1}"' + $val + '"'
            )
            if ($new -ne $text) {
              $text = $new
              $updated = $true
            }
          }
        }

        if ($updated) {
          Set-Content $file $text -Encoding utf8
          "updated=true" >> $env:GITHUB_OUTPUT
        } else {
          "updated=false" >> $env:GITHUB_OUTPUT
        }

    # -----------------------------
    # Commit & push
    # -----------------------------
    - name: Commit changes
      if: steps.replace.outputs.updated == 'true'
      shell: pwsh
      run: |
        $epochFile = ".github/next_run_epoch"
        Set-Content $epochFile "${{ steps.gate.outputs.next_epoch }}" -Encoding utf8

        git config user.name  "github-actions[bot]"
        git config user.email "actions@github.com"
        git add Windows11Upgrade.ps1 .github/next_run_epoch

        git diff --cached --quiet && exit 0
        git commit -m "Refresh Win11 ISO links $(Get-Date -Format yyyy-MM-dd_HH:mm)"
        git push
